name: Compilar
on:
  push:
    branches:
      - "main"
      - "test"
      - "dev"
jobs:
  build:
    runs-on: 'ubuntu-latest'

    steps:

    - name: Descarga del código
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    needs: build
    runs-on: 'ubuntu-latest'

    steps:

    - name: Descarga del código
      if: ${{ github.ref_name == 'main' }}
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Azure Login
      uses: Azure/login@v1.4.6
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true

    - name: Desplegar en BD Azure
      if: ${{ github.ref_name == 'main' }}
      uses: azure/sql-action@v2.2
      with:
        connection-string: ${{ secrets.CONN_STR }}
        path: 'Database/Database.sqlproj'
        action: 'publish'
        build-arguments: '-c Release'