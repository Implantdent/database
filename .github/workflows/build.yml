name: Compilar
on:
  push:
    branches:
      - "main"
      - "qa"
      - "dev"
jobs:
  build:
    runs-on: 'windows-latest'

    steps:

    - name: Descarga del código
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup MsBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: Build app for release
      run: msbuild ./Database.sln

  deploy:
    needs: build
    runs-on: 'windows-latest'

    steps:

    - name: Descarga del código
      if: ${{ github.ref_name == 'main' }}
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Azure Login
      if: ${{ github.ref_name == 'main' }}
      uses: Azure/login@v1.4.6
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Desplegar en BD Azure
      if: ${{ github.ref_name == 'main' }}
      uses: azure/sql-action@v2.2
      with:
        connection-string: ${{ secrets.CONN_STR }}
        path: 'Database/bin/Debug/Database.dacpac'
        action: 'publish'
        build-arguments: '-c Release'